=== APM - Dynatrace

==== Demo Architecture using Dynatrace Backend

Below is a description of the demo scenario used to generate distributed trace information from 2 Mule applications and have it
render in a Dynatrace backend.

image::Demo-Distributed-App-Arch.png[1200, 1200, title="Demo Architecture", align="center"]

<1> External application sending a request to Mule Application 1 with WC3 Trace Context Headers
<2> Mule App 1 sending a request to Mule App 2 and propagating the trace context via WC3 Trace Context Headers
<3> Responses coming back to calling application
<4> Responses coming back to calling application
<5> Both Mule applications sending log and metrics data to Anypoint Monitoring
<6> Mule 4 OpenTelemetry Module sending trace information to Dynatrace OTel Collector
<7> Dynatrace Collector forwarding the data to Dynatrace dashboard for rendering

==== Demo Architecture Mule Implementation Diagram

Below is an *implementation* of the demo architecture described above. At a high-level, *Mule_App_1* receives the initial request from
the *external client*, performs various functions including making a request to an external application, *Mule_App_2*, and calling a secondary
flow within Mule_App_1 before returning a response to the calling client application.

[NOTE]
The demo applications use a variety of Mule components to showcase how different message processors generate different span attributes,
including error events and log output.

image::Distributed-Mule-App-Diagram.png[title="Demo Mule Application Diagram", align="center"]


==== Example Output - Dynatrace Backend

Below are several screenshots from a Dynatrace Distributed Traces Dashboard to provide examples regarding the type of output generated
by the Mule 4 OpenTelemetry Module and visualized by observability backend.

===== Overall Distributed Trace Temporal Graph

image::dynatrace-distributed-span.png[title="Dynatrace - Complete Distributed Trace", align="center"]

As you can see in the graph above, the Agent generates spans in a manner which is *hierarchically consistent* with the progression of
a transaction through and between Mule applications.

<1> Represents the *overall* set of spans in the *distributed trace*.  Nested (child) spans are indented appropriately at each level.
<2> Represents the overall set of *spans* associated with the *external Mule application* (Mule_App_2). Nested (child) spans are
indented appropriately.
<3> Represents the overall set of *spans* associated with the *secondary flow* in Mule_App_1. Nested (child) spans are indented
appropriately.

===== Root Span Summary Details
Below is a screenshot of the summary details associated with a Mule Flow (Pipeline) span.  In this case, it's the trace root span
which has an HTTP Listener as its source trigger.  For the HTTP Listener, the Agent generates attributes such as the HTTP method,
the protocol (HTTP or HTTPs), the URI, the remote address, etc.

image::dynatrace-distributed-rootspan-summary.png[title="Dynatrace - Root Span Summary", align="center"]

<1> The *Metadata* is generated automatically by the OTel SDK.
<2> The *Attributes* data is generated by the Agent and specific to the span type, either a Flow(Pipeline) or Message Processor span
and if a Message Processor span then Message Processor type (e.g. Logger, Transform, DB, HTTP Requester, ...).
<3> The *Resource Attributes* are specified in the configuration of the Agent.  Resource Attributes can be a very convenient and
meaningful way of tagging the trace with information such as the application name, runtime environment (e.g., Production, QA,
Development,...), hosting region, etc. for easier correlation and search.

===== Logger Message Processor Output

As a matter of convenience, the Agent exports the output of the Logger processor.

image::dynatrace-distributed-span-logger-event.png[title="Dynatrace - Logger Processor Output Event", align="center"]

===== Database Processor Summary

Below is a diagram of the Database Processor specific attributes.  The extension will generate connection related attributes such as
connection type, host, port, database name and user as well operational attributes such as the SQL query type and statement.

image::dynatrace-distributed-db-summary.png[title="Dynatrace - Database Processor Summary", align="center"]

===== Database Processor Error Event

To facilitate triaging and remediation of faults, when an error occurs in a Mule application, the Agent exports the entire Mule
exception message.  For example, see the diagram below that displays a database *connection failure*. Rather than scrolling
through external log files, a user can simply look at the trace to find faults.

image::dynatrace-distributed-db-error-event.png[title="Dynatrace - Database Processor Error Event", align="center"]